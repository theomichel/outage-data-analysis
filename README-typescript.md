# TypeScript Outage Notifier

This is a TypeScript implementation of the outage notification system, providing the same functionality as the Python version.

## Features

- **Multi-utility support**: PSE, SCL, SnoPUD, and PG&E
- **Geospatial capabilities**:
  - Coordinate system transformations (EPSG:3857 to EPSG:4326) using proj4js
  - Zip code filtering using point-in-polygon with Turf.js
  - Smallest enclosing circle calculations
- **Outage tracking**: Detects new, resolved, and escalated outages
- **Telegram notifications**: Sends formatted alerts with location information
- **Reverse geocoding**: Converts coordinates to human-readable locations

## Setup

### Install Dependencies

```bash
npm install
```

### Build

```bash
npm run build
```

This compiles TypeScript files from `src/` to JavaScript in `dist/`.

## Usage

The TypeScript version has the same command-line interface as the Python version:

```bash
node dist/outage_notifier.js -u <utility> [options]
```

### Required Arguments

- `-u, --utility <utility>`: Utility name (pse, scl, snopud, pge)

### Optional Arguments

- `-d, --directory <dir>`: Directory containing outage files (default: current directory)
- `-r, --remaining_expected_length_threshold <hours>`: Minimum remaining expected length in hours (default: 4.0)
- `-c, --customer_threshold <count>`: Customers affected threshold (default: 100)
- `-lc, --large_outage_customer_threshold <count>`: Large outage customer threshold (default: 1000)
- `-e, --elapsed_time_threshold <hours>`: Minimum elapsed time in hours (default: 0.25)
- `--telegram-token <token>`: Telegram bot token
- `--telegram-chat-id <id>`: Telegram chat ID
- `--telegram-thread-id <id>`: Telegram thread ID (optional)
- `--geocode-api-key <key>`: Geocoding API key (optional)
- `--notification-output-dir <dir>`: Directory to save notification files (default: current directory)
- `-zw, --zip-whitelist-file <file>`: File containing zip codes to filter (one per line)
- `-zb, --zip-boundaries-file <file>`: GeoJSON file containing zip code boundaries

### Example

```bash
node dist/outage_notifier.js -u pse -d ./outage_data -c 500 --telegram-token YOUR_TOKEN --telegram-chat-id YOUR_CHAT_ID
```

## Dependencies

### Core Libraries

- **@turf/boolean-point-in-polygon**: Point-in-polygon operations (equivalent to GeoPandas spatial join)
- **@turf/helpers**: GeoJSON helper utilities
- **proj4**: Coordinate system transformations (EPSG conversions)
- **axios**: HTTP requests for Telegram API and geocoding
- **fast-xml-parser**: XML parsing for SnoPUD KML files
- **glob**: File pattern matching

## File Structure

```
src/
├── outage_notifier.ts   # Main notification logic
├── outage_utils.ts      # Utility-specific parsers and geospatial functions
└── zip_utils.ts         # Zip code filtering and point-in-polygon operations

dist/                    # Compiled JavaScript (generated by tsc)
```

## Implementation Notes

### Differences from Python Version

1. **Data structures**: Uses arrays of objects instead of pandas DataFrames
2. **Timezone handling**: Simplified timezone conversion (doesn't handle DST perfectly)
3. **Async/await**: Geocoding and Telegram API calls are async
4. **Type safety**: Full TypeScript type definitions for all data structures

### Geospatial Operations

The TypeScript implementation uses:

- **Turf.js** for point-in-polygon operations (replaces GeoPandas `sjoin`)
- **proj4js** for coordinate transformations (replaces GeoPandas `to_crs`)
- Custom implementation of smallest enclosing circle algorithm (same as Python version)

### Performance

The TypeScript version should have comparable performance to the Python version for typical workloads. The main bottleneck is I/O (file reading) and network requests (Telegram/geocoding), which are similar in both implementations.

## Testing

To test the implementation, run it on the same input files as the Python version and compare outputs:

```bash
# Python version
python outage_notifier.py -u pse -d ./test_data

# TypeScript version
node dist/outage_notifier.js -u pse -d ./test_data
```

Both should generate identical notification files in the output directory.

## License

Same as the Python version.
